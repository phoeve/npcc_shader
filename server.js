var rcpLayouts = {

    17:             // Home               
    {               
        'L001': {display: 17, label: 'Home'},
        'L002': {display: 18, label: 'Gain/Gamma'},
        'L003': {display: 19, label: 'Flare/Ped'},
        'L004': {display: 20, label: 'Matrix'},
        'L005': {display: 21, label: 'Color/Corr'},
        'L006': {display: 22, label: 'HDR'},
        'L007': {display: 25, label: 'Menu'},
        'L008': {display: 26, label: ''},


        1039:   {dial: 56, display: 29, label: 'F ',      func: 542, scale: 7}, 
        8392:   {dial: 31, display: 31, label: 'Gain ',   func: 8392},
        1809:   {led:  30, color: 2},                               // Tally  Skaarhoj 2=red


        523:    {dial:  9, display: 10, label: 'Dtl ',    func: 523},
        524:    {dial: 10, display: 10, label: 'Skn ',    func: 524},
        615:    {dial: 11, display: 11, label: 'Sat ',    func: 615},
        608:    {dial: 12, display: 12, label: 'Temp ',   relative:false, range:8000 ,func: 608},
        524:    {dial: 13, display: 13, label: '',        func: 0},
        8321:   {dial: 14, display: 14, label: 'Sens ',   func: 8321},
        1030:   {dial: 15, display: 15, label: 'ND ',     relative:false, range:4,    func: 1030},
        8200:   {dial: 16, display: 16, label: 'Scene ',  relative:false, range:5,    func: 4098},


    },

    18:             // Gain/Gamma
    {
        'L001': {display: 17, label: 'Home'},
        'L002': {display: 18, label: 'Gain/Gamma'},
        'L003': {display: 19, label: 'Flare/Ped'},
        'L004': {display: 20, label: 'Matrix'},
        'L005': {display: 21, label: 'Color/Corr'},
        'L006': {display: 22, label: 'HDR'},
        'L007': {display: 25, label: 'Menu'},
        'L008': {display: 26, label: ''},


        1039:   {dial: 56, display: 29, label: 'F ',      func: 542, scale: 7}, 
        8392:   {dial: 31, display: 31, label: 'Gain ',   func: 8392},
        1809:   {led:  30, color: 2},                               // Tally

        1026:   {dial:  9, display: 10, label: 'M',     func: 1026},
        513:    {dial: 10, display: 10, label: 'R',     func: 513},
        514:    {dial: 11, display: 11, label: 'G',     func: 514},
        515:    {dial: 12, display: 12, label: 'B',     func: 515},
        584:    {dial: 13, display: 13, label: 'M',     func: 584},
        583:    {dial: 14, display: 14, label: 'R',     func: 583},
        586:    {dial: 15, display: 15, label: 'G',     func: 586},
        585:    {dial: 16, display: 16, label: 'B',     func: 585},

    },

    19:             // Flare / PED
    {
        'L001': {display: 17, label: 'Home'},
        'L002': {display: 18, label: 'Gain/Gamma'},
        'L003': {display: 19, label: 'Flare/Ped'},
        'L004': {display: 20, label: 'Matrix'},
        'L005': {display: 21, label: 'Color/Corr'},
        'L006': {display: 22, label: 'HDR'},
        'L007': {display: 25, label: 'Menu'},
        'L008': {display: 26, label: ''},

        1039:   {dial: 56, display: 29, label: 'F ',      func: 542, scale: 7}, 
        8392:   {dial: 31, display: 31, label: 'Gain ',   func: 8392},
        1809:   {led:  30, color: 2},                               // Tally

        969:    {dial:  9, display: 10, label: 'M',     func: 969},
        519:    {dial: 10, display: 10, label: 'R',     func: 519},
        520:    {dial: 11, display: 11, label: 'G',     func: 520},
        521:    {dial: 12, display: 12, label: 'B',     func: 521},
        524:    {dial: 13, display: 13, label: 'M',     func: 0},
        524:    {dial: 14, display: 14, label: 'R',     func: 524},     // **************
        524:    {dial: 15, display: 15, label: 'G',     func: 524},
        524:    {dial: 16, display: 16, label: 'B',     func: 524},

    },

    20:             // Matrix
    {
        'L001': {display: 17, label: 'Home'},
        'L002': {display: 18, label: 'Gain/Gamma'},
        'L003': {display: 19, label: 'Flare/Ped'},
        'L004': {display: 20, label: 'Matrix'},
        'L005': {display: 21, label: 'Color/Corr'},
        'L006': {display: 22, label: 'HDR'},
        'L007': {display: 25, label: 'Menu'},
        'L008': {display: 26, label: ''},

        1039:   {dial: 56, display: 29, label: 'F ',      func: 542, scale: 7}, 
        8392:   {dial: 31, display: 31, label: 'Gain ',   func: 8392},
        1809:   {led:  30, color: 2},                               // Tally

        533:    {dial:  9, display: 10, label: 'R-G',     func: 533},
        534:    {dial: 10, display: 10, label: 'R-B',     func: 534},
        535:    {dial: 11, display: 11, label: 'G-R',     func: 535},
        536:    {dial: 12, display: 12, label: 'G-B',     func: 536},
        537:    {dial: 13, display: 13, label: 'B-R',     func: 537},
        538:    {dial: 14, display: 14, label: 'B-G',     func: 538},

    },

    21:             // Color / Correction
    {
        'L001': {display: 17, label: 'Home'},
        'L002': {display: 18, label: 'Gain/Gamma'},
        'L003': {display: 19, label: 'Flare/Ped'},
        'L004': {display: 20, label: 'Matrix'},
        'L005': {display: 21, label: 'Color/Corr'},
        'L006': {display: 22, label: 'HDR'},
        'L007': {display: 25, label: 'Menu'},
        'L008': {display: 26, label: ''},

        1039:   {dial: 56, display: 29, label: 'F ',      func: 542, scale: 7}, 
        8392:   {dial: 31, display: 31, label: 'Gain ',   func: 8392},
        1809:   {led:  30, color: 2},                               // Tally

        524:    {dial:  9, display: 10, label: 'SAT',     func: 524},
        524:    {dial: 10, display: 10, label: 'PHASE',     func: 524},
        524:    {dial: 11, display: 11, label: 'SAT',     func: 524},
        524:    {dial: 12, display: 12, label: 'PHASE',     func: 524}, //**********************
        524:    {dial: 13, display: 13, label: 'SAT',     func: 0},
        524:    {dial: 14, display: 14, label: 'PHASE',     func: 524},
        524:    {dial: 15, display: 15, label: 'SAT',       func: 524},
        524:    {dial: 16, display: 16, label: 'PHASE',       func: 524},   
        'sub': {
            'L001': {display: 17, label: 'S1'},
            'L002': {display: 18, label: 'S2'},
            'L003': {display: 19, label: 'S3'},
            'L004': {display: 20, label: 'S4'},
            'L005': {display: 21, label: 'S5'},
            'L006': {display: 22, label: 'S6'},

            1039:   {dial: 56, display: 29, label: 'F ',      func: 542, scale: 7}, 
            8392:   {dial: 31, display: 31, label: 'Gain ',   func: 8392},
            1809:   {led:  30, color: 2},                               // Tally

            524:    {dial:  9, display: 10, label: 'SAT',    func: 524},
            524:    {dial: 10, display: 10, label: 'PHASE',    func: 524},      //**************

            524:    {dial: 13, display: 13, label: 'SAT',        func: 0},
            524:    {dial: 14, display: 14, label: 'PHASE ',   func: 524},

            'super': 21, 
        }
    },


    22:             // HDR
    {
        'L001': {display: 17, label: 'Home'},
        'L002': {display: 18, label: 'Gain/Gamma'},
        'L003': {display: 19, label: 'Flare/Ped'},
        'L004': {display: 20, label: 'Matrix'},
        'L005': {display: 21, label: 'Color/Corr'},
        'L006': {display: 22, label: 'HDR'},
        'L007': {display: 25, label: 'Menu'},
        'L008': {display: 26, label: ''},


        1039:   {dial: 56, display: 29, label: 'F ',      func: 542, scale: 7}, 
        8392:   {dial: 31, display: 31, label: 'Gain ',   func: 8392},
        1809:   {led:  30, color: 2},                               // Tally

        524:    {dial:  9, display: 10, label: 'HDR Std',    func: 524},
        524:    {dial: 10, display: 10, label: 'HDR Out ',    func: 524},
        524:    {dial: 11, display: 11, label: '% Hi',    func: 524},
        524:    {dial: 12, display: 12, label: 'Point Hi',   func: 524},        //********************
        524:    {dial: 13, display: 13, label: '',        func: 0},
        524:    {dial: 14, display: 14, label: 'HDR Clip',   func: 524},
        524:    {dial: 15, display: 15, label: '% Low',     func: 524},
        524:    {dial: 16, display: 16, label: 'Point Low',  func: 524},

        'sub': {

            'L001': {display: 17, label: 'Home'},
            'L002': {display: 18, label: 'Gain/Gamma'},
            'L003': {display: 19, label: 'Flare/Ped'},
            'L004': {display: 20, label: 'Matrix'},
            'L005': {display: 21, label: 'Color/Corr'},
            'L006': {display: 22, label: 'HDR'},

            1039:   {dial: 56, display: 29, label: 'F ',      func: 542, scale: 7}, 
            8392:   {dial: 31, display: 31, label: 'Gain ',   func: 8392},
            1809:   {led:  30, color: 2},                               // Tally


            524:    {dial: 13, display: 13, label: 'SDR Level',        func: 0},    // ********************
            524:    {dial: 14, display: 14, label: 'SDR Clip',   func: 524},

            'super': 22,
        },
    },

    38:
    {
        'L001': {display: 17, label: 'S1'},
        'L002': {display: 18, label: 'S2'},
        'L003': {display: 19, label: 'S3'},
        'L004': {display: 20, label: 'S4'},
        'L005': {display: 21, label: 'S5'},
        'L006': {display: 22, label: 'S6'},
        'L007': {display: 25, label: 'AWB'},
        'L008': {display: 26, label: 'ABB'},
        'L009': {led: 25, color: 3},                // 3 = green
        'L010': {led: 26, color: 3},
    },
};

var rcpLay;

grassValley = require('./grass.js');
grassValleyEmitter = grassValley.connect();



var f1Lay = {
    1039: {dial: 53, display: 53, label: 'F ',      func: 542, scale: 10},      // Iris fine
    'L1039': {dial: 54, display: 54, label: 'Coarse', func: 542, scale: 100 },     // Iris Coarse
    8392: {dial: 55, display: 55, label: 'Gain ',   func: 8392},                // Gain
    // 1030: {dial: 56, display: 56, label: 'ND ',     func: 1030},                // ND Filter
    1030: {dial: 56, display: 56, label: 'ND ',     relative:false, range:4,    func: 1030},

}


// console.dir(f1Lay);


var buttonMap=[];  // Globals
var sliderMap=[];
var cameraMap=[];
var buttonLive = 0;

var RcpPageMap=[];

birch = require('./birch.js');
//console.log('Calling birch.init()');
birchEmitter = birch.init();


birchEmitter.on('initialized', () => {
    console.log('birchEmitter.on(initialized)');
    serverInit();
});


const Skaarhoj = require('./skaarhoj.js');
skaarhojF1 = new Skaarhoj('10.1.43.37');
skaarhojRCP = new Skaarhoj('10.1.45.54');




// console.dir(rcpLayouts);

// rcpLay = rcpLayouts[22];

// console.dir(rcpLay);

// console.dir(rcpLay);
// console.log('------------------');
// rcpLay = rcpLay['sub'];
// console.dir(rcpLay);

// console.log('------------------');
// rcpLay = rcpLayouts[rcpLay['super']];
// console.dir(rcpLay);

//paintRCP();




skaarhojF1.on('slider', (slider, position) => {

    if (!buttonLive)
        return;

    const scale = 2;

    console.log(skaarhojF1 +slider +' ' +position);

    if (!sliderMap[slider]){
        sliderMap[slider] = new Map();
        sliderMap[slider].position = 0;
        sliderMap[slider].timestamp = 0;
    }
    else{
        console.dir(position -sliderMap[slider].position *scale);

        grassValley.sendIrisValue(buttonMap[buttonLive].camera, 'true', (position - sliderMap[slider].position) * scale );   
    }

                            // Save slider position and timestamp
    sliderMap[slider].position = position;
    cameraMap[buttonMap[liveButton].camera].sliderPosition = position;  // Allows us to position slider when this camera is selected
    cameraMap[buttonMap[liveButton].camera].sliderTimestamp = Date.now();  // Allows us to position slider when this camera is selected

});


                        //
                        //  Fusion 1
                        //

skaarhojF1.on('dial', (dial, movement) => {

    if (!buttonLive)    // No camera selected ?
        return;

    Object.entries(f1Lay).forEach(entry => {

        if (dial == entry[1].dial){
            if (entry[1].scale === undefined)
                mult = 1;
            else
                mult = entry[1].scale;

            if (entry[1].relative === false){
                if (grassValues[buttonMap[buttonLive].camera][entry[1].func] != undefined){
                    var newValue = parseInt(grassValues[buttonMap[buttonLive].camera][entry[1].func]) +movement;
                    if (newValue > entry[1].range)
                        newValue=1;
                    else if (newValue < 1)
                        newValue=entry[1].range;

                    grassValley.sendFunctionValue(entry[1].func, buttonMap[buttonLive].camera, 'true', newValue);   
                }
            }
            else{
                grassValley.sendFunctionValue(entry[1].func, buttonMap[buttonLive].camera, 'true', movement *mult );   

            }

        }
    });

});



const recallSinglePresetF1 = 49;
const recallAllPresetF1 = 28;
const rebootF1 = 18;

skaarhojF1.on('button', (pressed, position) => {

    if (position == 'Up')
        return;                 // F1 pabel doesn't care about the buttons' "Up" movement

    if (buttonMap[pressed]){      // Camera select button pressed ?

        buttonLive = pressed;            // save the live button

        resetButtonsNLabels(); 

            // Send GV OCP camera name to shade
        grassValley.ocpSetCamera(buttonMap[pressed].camera);

            // Send birch request route camera to shader monitor
        birch.take(cameraMap[buttonMap[pressed].camera].birchObj, birch.destinations[0]);

            // Set button colors   red=2, green=3
        skaarhojF1.hwcColor(pressed, '3');          // set "pushed" to green

        paintRCP();

        grassValley.subscribe2Camera(buttonMap[pressed].camera);        // Subscribe to camera changes in iris, gain, nd, ...
    }
    else
    {
        switch (pressed){          
                                // Recall Single Camera Preset
            case recallSinglePresetF1:
                if (buttonLive){
                    grassValley.sendPresetRecall(buttonMap[buttonLive].camera, 2);      // 2 => File 1
                    cameraPresetLEDs(pressed);
                }
                break;
            case recallSinglePresetF1 +1:
                if (buttonLive){
                    grassValley.sendPresetRecall(buttonMap[buttonLive].camera, 3);      // 3 => File 2
                    cameraPresetLEDs(pressed);
                }
                break;
            case recallSinglePresetF1 +2:
                if (buttonLive){
                    grassValley.sendPresetRecall(buttonMap[buttonLive].camera, 4);      // 4 => File 3
                    cameraPresetLEDs(pressed);
                }
                break;
            case recallSinglePresetF1 +3:
                if (buttonLive){
                    grassValley.sendPresetRecall(buttonMap[buttonLive].camera, 5);      // 5 => File 4
                    cameraPresetLEDs(pressed);
                }
                break;

                                // Recall All CamerasPreset
            case recallAllPresetF1:
                cameraMap.forEach(function(obj){
                    grassValley.sendPresetRecall(obj.cameraNum, 2);   // 2 => File 1
                    obj.presetButton = 0;                           // Clear the camera's individual Preset
                });
                allCamerasPresetLEDs(pressed)
                break;
            case recallAllPresetF1 +1:
                cameraMap.forEach(function(obj){
                    grassValley.sendPresetRecall(obj.cameraNum, 3);   // 3 => File 2
                    obj.presetButton = 0;
                });
                allCamerasPresetLEDs(pressed)
                break;
            case recallAllPresetF1 +2:
                cameraMap.forEach(function(obj){
                    grassValley.sendPresetRecall(obj.cameraNum, 4);   // 4 => File 3
                    obj.presetButton = 0;
                });
                allCamerasPresetLEDs(pressed)
                break;
            case recallAllPresetF1 +3:
                cameraMap.forEach(function(obj){
                    grassValley.sendPresetRecall(obj.cameraNum, 5);   // 5 => File 4
                    obj.presetButton = 0;
                });
                allCamerasPresetLEDs(pressed)
                break;

            case rebootF1:            // RESET ALL ... exit()
                process.exit(1);    // program exit will cause docker to restart this
                break;

            default:
                console.log('Unmapped button pressed: ' +pressed);
        }

    }
});


                        //
                        //  RCP
                        //

skaarhojRCP.on('dial', (dial, movement) => {

    if (!buttonLive)    // No camera selected ?
        return;

                // Preprocess special functions

    Object.entries(rcpLay).forEach(entry => {
        // console.dir(entry);
        // console.dir(dial);
        if (dial == entry[1].dial){
            // console.dir(entry);
            if (entry[1].scale === undefined)
                mult = 1;
            else
                mult = entry[1].scale;

            if (entry[1].relative === false){
                if (grassValues[buttonMap[buttonLive].camera][entry[1].func] != undefined){
                    var newValue = parseInt(grassValues[buttonMap[buttonLive].camera][entry[1].func]) +movement;
                    if (newValue > entry[1].range)
                        newValue=1;
                    else if (newValue < 1)
                        newValue=entry[1].range;

                    grassValley.sendFunctionValue(entry[1].func, buttonMap[buttonLive].camera, 'true', newValue);   
                }
            }
            else{
                grassValley.sendFunctionValue(entry[1].func, buttonMap[buttonLive].camera, 'true', movement *mult );   

            }
  
        }
    });

});



function paintRCP()
{

    if (rcpLay === undefined)
        rcpLay = rcpLayouts[17];
 
    Object.entries(rcpLay).forEach(hwc => {

        if(hwc[0] == 'sub' || hwc[0] == 'shift')
            return;

        if (hwc[1].led){            // Just light up an LED (not a display w/label)
            if (grassValues[buttonMap[buttonLive].camera] != undefined &&
                                                grassValues[buttonMap[buttonLive].camera][hwc[0]] == 'true')
                skaarhojRCP.hwcColor(hwc[1].led, hwc[1].color); 
            else
                skaarhojRCP.hwcColor(hwc[1].led, 0); 
        }
        else{
            if (grassValues[buttonMap[buttonLive].camera] === undefined ||
                                                       grassValues[buttonMap[buttonLive].camera][hwc[0]] === undefined)      // Does this have a GV function value?
                skaarhojRCP.hwcLabel(hwc[1].display, hwc[1].label);    // Just a label :)
            else
                skaarhojRCP.hwcLabel(hwc[1].display, hwc[1].label +grassValues[buttonMap[buttonLive].camera][hwc[0]]);
        }
    });
}
                        //
                        //  RCP
                        //
var lastRcpLayout;

skaarhojRCP.on('button', (pressed, position) => {

    // if (position == 'Up')
        // console.log(pressed +' is Up');                 // F1 pabel doesn't care about the buttons' "Up" movement


    switch (pressed){ 

        case 1:             // Screen change Key ??
            if (position == 'Down' && rcpLayouts[rcpLay['super']])
                rcpLay = rcpLayouts[rcpLay['super']]; // Display parent screen
        break;

        case 2:             // SubScreen 
            if (position == 'Down' && rcpLay[2])
                rcpLay = rcpLay['sub']; // Display subscreen
        break;

        case 38:            // Shift Key 
            if (position == 'Down'){  
                lastRcpLayout = rcpLay;
                rcpLay = rcpLayouts[pressed];
            }
            else{
                rcpLay = lastRcpLayout;             // Display previous screen
            }
        break;

        case 17:            // Home mode 
        case 18:            // Gain/Gamma Mode 
        case 19:            // Flare/PED mode 
        case 20:            // Matrix 1,2
        case 21:            // Color 1,2
        case 22:            // HDR 1,2 
            if (position == 'Down')
                rcpLay = rcpLayouts[pressed];
            break;

        case 25:            // AWB=8193  State=809
            if (position == 'Down')
                grassValley.sendFunctionValue(8193, buttonMap[buttonLive].camera, 'true', 'true');   
            break;
        case 26:            // ABB=8198  State=???
            if (position == 'Down')
                grassValley.sendFunctionValue(8198, buttonMap[buttonLive].camera, 'true', 'true');   
            break;

        default:
            console.log('Unmapped button pressed: ' +pressed +' ' +position);
    }


    paintRCP();
});


var grassValues=[];

grassValleyEmitter.on('func', (func, camera, value) => {
    console.log('camera: ' +camera +' func: ' +func + ' value:' +value);

    if (grassValues[camera] === undefined)
        grassValues[camera] = [];

    grassValues[camera][func] = value;          // Save latest value by camera/func

    if (buttonLive && camera == buttonMap[buttonLive].camera){

                // Special function handling here ...

        if (f1Lay[func] != undefined)
            skaarhojF1.hwcLabel(f1Lay[func].display, f1Lay[func].label +value);

        if (rcpLay[func] != undefined)
            skaarhojRCP.hwcLabel(rcpLay[func].display, rcpLay[func].label +value);
    }
});



function serverInit()
{

    var button;
    var camera;

    console.dir(birch.sources);
    
    for(i=0; i<birch.sources.length; i++){

                            // Initial Camera to Button Mapping - Naming driven by Birch
                            //
        switch (birch.sources[i].name){
            case 'NP CAM 1':
                button=1;
                camera=1;
                break;
            case 'NP CAM 2':
                button=2;
                camera=2;
                break;
            case 'NP CAM 3':
                button=3;
                camera=3;
                break;
            case 'NP CAM 6':
                button=4;
                camera=6;
                break;
            case 'NP CAM 7':
                button=5;
                camera=7;
                break;
            case 'NP CAM 8':
                button=6;
                camera=8;
                break;
            case 'NP CAM 10':
                button=13;
                camera=10;
                break;
        }

        cameraMap[camera] = new Object();
        cameraMap[camera].button = button;
        cameraMap[camera].birchObj = birch.sources[i];
        cameraMap[camera].ndFilter = 1;    // ND filters 1-4 on GrassValley
        cameraMap[camera].cameraNum = camera;
        cameraMap[camera].presetButton = 0;

        buttonMap[button] = new Object();
        buttonMap[button].camera = camera;
        buttonMap[button].name = birch.sources[i].name;

        //grassValley.subscribe2Camera(camera);        // Subscribe to camera changes in iris, gain, nd, ...

    } // for loop

    console.dir(buttonMap);
    console.dir(cameraMap);

    resetButtonsNLabels();

}

function resetButtonsNLabels()
{
    for(i=0;i<buttonMap.length;i++){
        if(buttonMap[i]){
            skaarhojF1.hwcColor(i, '0');      // set all to green
            skaarhojF1.hwcColor(i+6, '0');      // set flags to off
            skaarhojF1.hwcLabel(i, buttonMap[i].name);
        }
    }
    skaarhojF1.hwcLabel(54, 'Coarse');
    skaarhojF1.hwcLabel(47, 'Preset');
    if (buttonLive){
        cameraPresetLEDs(0);    // Clear all 4 then light single below
        skaarhojF1.hwcLabel(48, buttonMap[buttonLive].name);
        if (cameraMap[buttonMap[buttonLive].camera].presetButton)
            skaarhojF1.hwcColor(cameraMap[buttonMap[buttonLive].camera].presetButton, 3);       //  Green is 3
    }
    skaarhojF1.hwcLabel(25, 'Preset ALL Cams');
    skaarhojF1.hwcLabel(18, 'Reset Panel');            // Force program to exit

    if (!buttonLive){    // We just started up - no camera selected
        allCamerasPresetLEDs(0);     // Clear "All Camera" preset buttons
        cameraPresetLEDs(0);        // Clear individual camera preset buttons
    }
    else{
        skaarhojRCP.hwcLabel(38, buttonMap[buttonLive].name)
    }
}

function cameraPresetLEDs(pressed)
{
    for (i=49;i<53;i++)                 // Individual Camera Preset LEDs
        skaarhojF1.hwcColor(i, 0);

    if (pressed){
        skaarhojF1.hwcColor(pressed, 3);       //  Green is 3
        cameraMap[buttonMap[buttonLive].camera].presetButton = pressed;
    }
}

function allCamerasPresetLEDs(pressed)
{
    for (i=28;i<32;i++){                 // All Cameras Preset LEDs
        skaarhojF1.hwcColor(i, 0);
    }

    if (pressed)
        skaarhojF1.hwcColor(pressed, 3);

    cameraPresetLEDs(0);   // All cameras Profile ... clear this cameras individual Profile LEDs
}


